# hvisor Github Actions CI
# wheatfox <wheatfox17@icloud.com>
#
# 此工作流已更新为使用预构建的 Docker 容器，并修复了在 GitHub Actions 环境中的网络问题。

name: CI

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

env:
  MODE: debug
  #
  # ============================== 重要 ==============================
  # 请将下面的路径替换为您在容器仓库中的 CI 镜像路径。
  #
  CI_IMAGE: ghcr.io/wheatfox/hvisor:ci-latest # <-- 请务必替换此行为您自己的镜像路径!

jobs:
  linter:
    name: linter
    runs-on: ubuntu-latest
    container: ghcr.io/jaxtonmax/hvisor-ci:wzm_1.0.2 
    # === FIX: 覆盖容器内的环境变量以使用官方 Rust 源 ===
    # 解决从 GitHub Actions Runner 访问国内镜像超时的问题。
    env:
      RUSTUP_DIST_SERVER: "https://static.rust-lang.org"
      RUSTUP_UPDATE_ROOT: "https://static.rust-lang.org/rustup"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # === FIX: 禁用 rustup 自动更新以增加稳定性 ===
      - name: Disable rustup auto update
        run: rustup set auto-self-update disable

      - name: Format Check
        run: make fmt-test

  unittest:
    name: unittest
    runs-on: ubuntu-latest
    container: ghcr.io/jaxtonmax/hvisor-ci:wzm_1.0.2 
    # === FIX: 覆盖容器内的环境变量以使用官方 Rust 源 ===
    env:
      RUSTUP_DIST_SERVER: "https://static.rust-lang.org"
      RUSTUP_UPDATE_ROOT: "https://static.rust-lang.org/rustup"
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: aarch64
            board: "qemu-gicv3"
          - arch: aarch64
            board: "qemu-gicv2"
          - arch: riscv64
            board: "qemu-plic"
          - arch: riscv64
            board: "qemu-aia"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # === FIX: 禁用 rustup 自动更新以增加稳定性 ===
      - name: Disable rustup auto update
        run: rustup set auto-self-update disable

      - name: Set up environment variables
        run: |
          echo "ARCH=${{ matrix.arch }}" >> $GITHUB_ENV
          echo "BOARD=${{ matrix.board }}" >> $GITHUB_ENV
      - name: Unit Test
        run: make test

  build:
    name: build
    runs-on: ubuntu-latest
    container: ghcr.io/jaxtonmax/hvisor-ci:wzm_1.0.2 
    # === FIX: 覆盖容器内的环境变量以使用官方 Rust 源 ===
    env:
      RUSTUP_DIST_SERVER: "https://static.rust-lang.org"
      RUSTUP_UPDATE_ROOT: "https://static.rust-lang.org/rustup"
    strategy:
      fail-fast: false
      matrix:
        include:
          # aarch64
          - arch: aarch64
            board: "qemu-gicv3"
          - arch: aarch64
            board: "qemu-gicv2"
          - arch: aarch64
            board: "zcu102"
          - arch: aarch64
            board: "imx8mp"
          - arch: aarch64
            board: "rk3568"
          - arch: aarch64
            board: "rk3588"
          - arch: aarch64
            board: "ok6254-c"
          # riscv64
          - arch: riscv64
            board: "qemu-aia"
          - arch: riscv64
            board: "qemu-plic"
          # loongarch64
          - arch: loongarch64
            board: "ls3a5000"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # === FIX: 禁用 rustup 自动更新以增加稳定性 ===
      - name: Disable rustup auto update
        run: rustup set auto-self-update disable

      - name: Set up environment variables
        run: |
          echo "ARCH=${{ matrix.arch }}" >> $GITHUB_ENV
          echo "BOARD=${{ matrix.board }}" >> $GITHUB_ENV
      - name: Build
        run: make

  systemtest:
    name: systemtest
    runs-on: ubuntu-22.04
    container: 
      image: ghcr.io/jaxtonmax/hvisor-ci:wzm_1.0.2 
      options: --cap-add=SYS_ADMIN --privileged
    env:
      RUSTUP_DIST_SERVER: "https://static.rust-lang.org"
      RUSTUP_UPDATE_ROOT: "https://static.rust-lang.org/rustup"
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: aarch64
            board: "qemu-gicv3"
          - arch: riscv64
            board: "qemu-plic"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Disable rustup auto update
        run: rustup set auto-self-update disable

      - name: Set up environment variables
        run: |
          echo "ARCH=${{ matrix.arch }}" >> $GITHUB_ENV
          echo "BOARD=${{ matrix.board }}" >> $GITHUB_ENV

      # === FIX 1: 安装完整的交叉编译工具链 ===
      # 直接安装 gcc 包，可以确保其所有依赖（包括 libc6-dev 和头文件）都被正确安装。
      # - name: Install Full Cross-Compile Toolchain
      #   run: |
      #     echo "### Installing full cross-compile toolchain for ${{ matrix.arch }} ###"
      #     sudo apt-get update
      #     if [ "${{ matrix.arch }}" = "aarch64" ]; then
      #       sudo apt-get install -y gcc-aarch64-linux-gnu;
      #       sudo apt-get install -y libc6-dev-arm64-cross
      #     elif [ "${{ matrix.arch }}" = "riscv64" ]; then
      #       sudo apt-get install -y gcc-riscv64-linux-gnu;
      #       sudo apt-get install -y libc6-dev-riscv64-cross
      #     fi

      # === 验证步骤：现在应该能看到 include 目录了 ===
      - name: Verify Sysroot Directories Exist
        run: |
          echo "### Verifying Sysroot for ${{ matrix.arch }} ###"
          if [ "${{ matrix.arch }}" = "aarch64" ]; then
            SYSROOT_PATH="/usr/aarch64-linux-gnu"
          elif [ "${{ matrix.arch }}" = "riscv64" ]; then
            SYSROOT_PATH="/usr/riscv64-linux-gnu"
          fi
          echo "--- Checking main sysroot directory: ${SYSROOT_PATH} ---"
          ls -la "${SYSROOT_PATH}"
          echo "--- Verifying include directory exists: ${SYSROOT_PATH}/include ---"
          # 这个 ls 如果失败，整个步骤就会失败，非常明确
          ls -d "${SYSROOT_PATH}/include"

      # # === FIX 2: 使用更健壮的方式来修复构建脚本 ===
      # # 不再替换整行，而是在找到目标行后，在行尾追加 CFLAGS，这能避免空格等问题。
      # - name: Robustly Patch Cross-Compile Command with Correct Sysroot
      #   run: |
      #     if [ "${{ matrix.arch }}" = "aarch64" ]; then
      #       SYSROOT_PATH="/usr/aarch64-linux-gnu"
      #       # 只搜索关键部分，使其更健壮
      #       MAKE_KEYWORD="make all ARCH=arm64"
      #     elif [ "${{ matrix.arch }}" = "riscv64" ]; then
      #       SYSROOT_PATH="/usr/riscv64-linux-gnu"
      #       MAKE_KEYWORD="make all ARCH=riscv64"
      #     else
      #       echo "Unsupported architecture for patching: ${{ matrix.arch }}"
      #       exit 1
      #     fi

      #     SCRIPT_PATH="platform/${{ matrix.arch }}/${{ matrix.board }}/test/systemtest/trootfs_deploy.sh"

      #     if [ -f "$SCRIPT_PATH" ]; then
      #       echo "Patching '$SCRIPT_PATH' to add correct sysroot for cross-compilation..."
      #       # 在包含 MAKE_KEYWORD 的那一行结尾($)追加我们的 CFLAGS
      #       sed -i "/${MAKE_KEYWORD}/ s/$/ CFLAGS='--sysroot=${SYSROOT_PATH}'/" "$SCRIPT_PATH"
            
      #       echo "Patch applied successfully. Verifying content:"
      #       # grep 现在只检查我们添加的内容是否存在，只要存在就不会报错
      #       grep --color=always -- "--sysroot=${SYSROOT_PATH}" "$SCRIPT_PATH"
      #     else
      #       echo "Warning: Build script $SCRIPT_PATH not found. Skipping patch."
      #       # 如果脚本不存在，也应该让它失败，因为这是一个错误
      #       exit 1
      #     fi

      - name: Run System Test
        run: make stest

  # 此作业很轻量，保持不变
  license-checker:
    name: license-checker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: License Check
        run: |
          set -x
          ./tools/license_checker.sh